@startuml 06-리소스평가
!theme mono

title 06. 리소스 평가 및 후기 작성

actor "일반 사용자" as User
participant "웹 인터페이스" as UI
participant "평가 서비스" as Rating
participant "추천 엔진" as Recommend
participant "신뢰도 검증 시스템" as Trust
participant "알림 서비스" as Notification
database "평가 DB" as RatingDB
database "리소스 DB" as ResourceDB
database "사용자 DB" as UserDB

== 평가 대상 선택 ==

User -> UI : 리소스 상세 페이지에서 "평가하기" 클릭
activate UI

note right of User
**Command**: 평가 시작
**데이터**: 
- 리소스 ID
- 리소스 유형 (prompt/case/cheatsheet/starterkit)
end note

alt 이미 평가한 리소스인 경우
    UI -> RatingDB : 기존 평가 확인
    activate RatingDB
    RatingDB --> UI : 기존 평가 데이터
    deactivate RatingDB
    
    UI --> User : 기존 평가 표시 및 수정 옵션 제공
end

UI -> Rating : 평가 폼 요청
activate Rating

Rating -> ResourceDB : 리소스 사용 이력 확인
activate ResourceDB

note over ResourceDB
**Policy**: 평가 자격 규칙
- 다운로드/사용한 리소스만 평가 가능
- 사용 후 최소 24시간 경과
- 스팸 방지: 일일 평가 제한 (20개)
end note

alt 사용 이력 없음
    ResourceDB --> Rating : 사용 이력 없음
    deactivate ResourceDB
    Rating --> UI : 권한 없음 메시지
    UI --> User : "먼저 사용 후 평가해주세요" 안내
    
else 사용 이력 있음
    ResourceDB --> Rating : 사용 이력 확인
    deactivate ResourceDB
    
    Rating --> UI : 평가 폼 데이터
    deactivate Rating
    
    UI --> User : 평가 작성 화면 표시
end

== 평가 작성 ==

User -> UI : 평가 정보 입력
note right of User
**Command**: 평가 제출
**데이터**: 
- 리소스 ID
- 별점 (1-5점)
- 평가 항목별 점수:
  * 정확성/유용성 (1-5)
  * 이해 용이성 (1-5)
  * 실무 적용성 (1-5)
  * 가성비 (프리미엄의 경우)
- 한 줄 요약
- 상세 후기 (선택)
- 사용 기간
- 업무 개선 효과 (선택)
- 추천 대상 (선택)
- 첨부 이미지 (선택)
end note

UI -> Rating : 평가 데이터 전송
activate Rating

Rating -> Rating : 평가 내용 검증

note over Rating
**Policy**: 평가 검증 규칙
- 별점 필수
- 한 줄 요약 최소 10자
- 욕설/비방 필터링 (AI 기반)
- 의미 없는 반복 문자 차단
- 스팸 패턴 감지
end note

alt 검증 실패
    Rating --> UI : 검증 오류 메시지
    UI --> User : 수정 요청
    User -> UI : 내용 수정 후 재제출
end

Rating -> Trust : 신뢰도 검증 요청
activate Trust

note over Trust
**Policy**: 신뢰도 검증 규칙
- 극단적 평가 (1점 or 5점만) 사용자 검증
- 짧은 시간 내 다수 평가 의심
- 동일 패턴 반복 평가 탐지
- 사용자 평판 점수 고려
- 의심 평가는 '검증 필요' 상태로 표시
end note

Trust -> UserDB : 사용자 평가 이력 조회
activate UserDB
UserDB --> Trust : 평가 패턴 데이터
deactivate UserDB

Trust -> Trust : 신뢰도 점수 계산 (0-100)

note over Trust
**Event**: 신뢰도 검증 완료
**데이터**:
- 신뢰도 점수 (0-100)
- 검증 상태 (verified/pending/flagged)
- 검증 사유
end note

Trust --> Rating : 신뢰도 점수 반환
deactivate Trust

Rating -> RatingDB : 평가 저장
activate RatingDB

note over RatingDB
**Event**: 평가 작성됨
**데이터**:
- 평가 ID
- 리소스 ID
- 사용자 ID
- 별점 (총점 및 항목별)
- 한 줄 요약
- 상세 후기
- 신뢰도 점수
- 작성 시각
- 사용 기간
- 개선 효과
- 추천 대상
- 첨부 이미지 URL
- 검증 상태
end note

RatingDB --> Rating : 저장 완료
deactivate RatingDB

Rating -> ResourceDB : 리소스 평균 평점 업데이트
activate ResourceDB

note over ResourceDB
**Policy**: 평균 평점 계산 규칙
- 신뢰도 70점 이상 평가만 반영
- 가중 평균 사용 (최근 평가 가중치 높음)
- 최소 3개 평가 이상부터 공개
- 평가 수 함께 표시
end note

ResourceDB -> ResourceDB : 평균 평점 재계산

note over ResourceDB
**Event**: 리소스 평점 업데이트됨
**데이터**:
- 새로운 평균 평점
- 총 평가 수
- 별점 분포 (1-5점 각각 개수)
- 마지막 업데이트 시각
end note

ResourceDB --> Rating : 업데이트 완료
deactivate ResourceDB

Rating -> UserDB : 사용자 평판 점수 증가
activate UserDB

note over UserDB
**Event**: 평가 작성으로 평판 증가
**Policy**: 평판 점수 규칙
- 평가 작성: +3점
- 상세 후기 포함: +5점 추가
- 이미지 첨부: +2점 추가
- "도움됨" 투표 받을 때마다 +1점
end note

UserDB --> Rating : 평판 점수 업데이트 완료
deactivate UserDB

Rating --> UI : 평가 등록 완료
deactivate Rating

UI --> User : 평가 완료 메시지\n"평가해주셔서 감사합니다! +X점 획득"

== 평가 노출 및 유용성 투표 ==

User -> UI : 다른 사용자의 평가 목록 조회
activate UI

UI -> Rating : 평가 목록 요청
activate Rating

Rating -> RatingDB : 평가 조회
activate RatingDB

note over RatingDB
**Policy**: 평가 정렬 규칙
- 기본: 유용성 투표 순
- 옵션: 최신순, 별점 높은 순, 낮은 순
- 신뢰도 낮은 평가는 하단 표시
- "검증 필요" 평가는 흐릿하게 표시
end note

RatingDB --> Rating : 평가 목록
deactivate RatingDB

Rating --> UI : 평가 목록 반환
deactivate Rating

UI --> User : 평가 목록 표시\n(별점, 한 줄 요약, 작성자, 유용성 투표 수)

User -> UI : 특정 평가 상세 보기
UI --> User : 평가 상세 내용\n(상세 후기, 이미지, 댓글)

User -> UI : "도움이 됐어요" 버튼 클릭
note right of User
**Command**: 유용성 투표
**데이터**: 
- 평가 ID
- 투표 유형 (helpful/not_helpful)
end note

UI -> Rating : 유용성 투표 요청
activate Rating

note over Rating
**Policy**: 유용성 투표 규칙
- 자신의 평가에는 투표 불가
- 한 평가당 1회만 투표 가능
- 투표 취소/변경 가능
end note

Rating -> RatingDB : 유용성 카운트 증가
activate RatingDB

note over RatingDB
**Event**: 유용성 투표됨
**데이터**:
- 평가 ID
- 투표자 ID
- 투표 유형
- 투표 시각
end note

RatingDB --> Rating : 업데이트 완료
deactivate RatingDB

Rating -> UserDB : 평가 작성자 평판 점수 증가
activate UserDB
UserDB --> Rating : 평판 업데이트 완료
deactivate UserDB

Rating -> Notification : 평가 작성자에게 알림
activate Notification

note over Notification
**Event**: 유용성 투표 알림 발송
**데이터**:
- 대상: 평가 작성자
- 평가 ID
- 투표 수 (누적)
end note

Notification --> Rating : 알림 완료
deactivate Notification

Rating --> UI : 투표 완료
deactivate Rating

UI --> User : 투표 완료 피드백 (버튼 하이라이트)

== 평가 기반 추천 ==

UI -> Recommend : 평가 데이터 기반 추천 요청
activate Recommend

note over Recommend
**Policy**: 추천 규칙
- 높은 평가를 준 리소스와 유사한 것
- 같은 직무/업무 유형 중 높은 평가 리소스
- 아직 사용하지 않은 인기 리소스
end note

Recommend -> RatingDB : 사용자 평가 패턴 분석
activate RatingDB
RatingDB --> Recommend : 선호도 데이터
deactivate RatingDB

Recommend --> UI : 추천 리소스 목록
deactivate Recommend

UI --> User : "이런 리소스는 어떠세요?" 추천 표시

deactivate UI

note over User
**Next Steps**:
- 추천받은 리소스 탐색
- 평가한 리소스 실무 활용
- 주기적 평가 업데이트
end note

@enduml
